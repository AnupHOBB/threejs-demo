<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src='../node_modules/three/build/three.min.js'></script>
		<script src="../node_modules/ar.js/three.js/build/ar.js"></script>
		<!-- <script>THREEx.ArToolkitContext.baseURL = '../'</script> -->
		<script>
			window.onload = () => {
				let renderer = new THREE.WebGLRenderer({antialias: true, alpha: true})
				renderer.setClearColor(new THREE.Color('lightgrey'), 0)
				renderer.setSize( 640, 480 );
				renderer.domElement.style.position = 'absolute'
				renderer.domElement.style.top = '0px'
				renderer.domElement.style.left = '0px'
				document.body.appendChild( renderer.domElement );
			
				let onRenderFcts= [];
			
				let scene	= new THREE.Scene();
			
				let camera = new THREE.Camera();
				scene.add(camera);
			
				let arToolkitSource = new THREEx.ArToolkitSource({sourceType : 'webcam'})
			
				arToolkitSource.init(function onReady(){
					onResize()
				})
			
				window.addEventListener('resize', function(){
					onResize()
				})
			
				function onResize(){
					arToolkitSource.onResizeElement()
					arToolkitSource.copyElementSizeTo(renderer.domElement)
					if( arToolkitContext.arController !== null ){
						arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
					}
				}
			
				let arToolkitContext = new THREEx.ArToolkitContext({
					cameraParametersUrl: 'camera_para.dat',
					detectionMode: 'color_and_matrix',
				})
			
				arToolkitContext.init(function onCompleted(){
					camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
				})
			
				onRenderFcts.push(function(){
					if( arToolkitSource.ready === false )	
						return
					arToolkitContext.update( arToolkitSource.domElement )
					scene.visible = camera.visible
				})
			
				let markerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
					type : 'pattern',
					patternUrl : 'pattern-marker.patt',
					changeMatrixMode: 'cameraTransformMatrix'
				})
				scene.visible = false
			
				let video = document.querySelector('video')
				document.body.removeChild(video)
				let videoTexture = new THREE.VideoTexture(video)
			
				let front = new THREE.Vector3(0, 0, 1)

				let geometry	= new THREE.Plane(front, -1)//new THREE.BoxGeometry(1.5,1,1);
				let material	= new THREE.MeshNormalMaterial({
					opacity: 1,
					side: THREE.FrontSide,
					map: videoTexture
				});
				let mesh	= new THREE.Mesh( geometry, material );
				//mesh.position.y	= geometry.parameters.height/2
				scene.add( mesh );
			
				/* onRenderFcts.push(function(delta){
					mesh.rotation.x += Math.PI*delta
				}) */
			
				onRenderFcts.push(function(){
					camera.getWorldDirection(front)
					plane.normal = new THREE.Vector3(-front.x, -front.y, -front.z)
					renderer.render( scene, camera )
				})
			
				var lastTimeMsec= null
				requestAnimationFrame(function animate(nowMsec){
					requestAnimationFrame( animate );
					lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
					var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
					lastTimeMsec	= nowMsec
					onRenderFcts.forEach(function(onRenderFct){onRenderFct(deltaMsec/1000, nowMsec/1000)})
				})
			}
		</script>
	</head>
	<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>
		<video src="vid.mp4"></video>
	</body>
</html>